<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css' rel='stylesheet' />
    <style>
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        #calendar {
            max-width: 900px;
            margin: 0 auto;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white p-4">
        <ul class="flex space-x-6">
            <li><a href="#manage-bookings" class="tab-link">Manage Bookings</a></li>
        </ul>
    </nav>

    <div class="container mx-auto p-4">
        <div id="manage-bookings" class="tab-content">
            <h2 class="text-2xl font-bold mb-4">Manage Bookings</h2>
            <form id="user-auth-form" class="mb-6">
                <div class="mb-4">
                    <label for="user-name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="user-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="user-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="user-email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Submit Identity</button>
                <p id="identity-status" class="mt-2 text-green-500"></p>
            </form>
            <div class="mb-4" id="form-selection" style="display: none;">
                <label for="form-select" class="block text-sm font-medium text-gray-700">Select Form:</label>
                <select id="form-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    <option value="cisd">CISD Form -TUS</option>
                    <option value="apt">APT Booking</option>
                </select>
            </div>

            <!-- CISD Form -->
            <div id="cisd-form" class="form-section">
                <h3 class="text-xl font-bold mb-2">CISD Booking/Request/Training/Facility Tour</h3>
                <p class="text-sm text-gray-600 mb-4">Submit requests 3 days in advance. Await CISD staff approval.</p>
                <form id="cisd-form-fields">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Have you completed the safety
                            documentation?</label>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                <input type="radio" name="cisd-safety" value="yes" class="form-radio" required>
                                <span class="ml-2">Yes</span>
                            </label>
                            <label class="inline-flex items-center ml-6">
                                <input type="radio" name="cisd-safety" value="no" class="form-radio">
                                <span class="ml-2">No</span>
                            </label>
                        </div>
                        <p id="cisd-safety-message" class="text-red-500 hidden">You'll need to complete safety
                            documentation to proceed.</p>
                    </div>
                    <div class="mb-4">
                        <label for="cisd-purpose" class="block text-sm font-medium text-gray-700">Purpose of your
                            request</label>
                        <select id="cisd-purpose" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                            required>
                            <option value="sample-analysis">Sample analysis (Drop-in)</option>
                            <option value="test-equipment">Test Equipment Booking</option>
                            <option value="training">Training</option>
                            <option value="facility-tour">Research HUB/CISD - Facility tour</option>
                        </select>
                    </div>
                    <div id="cisd-equipment-training" class="mb-4 hidden">
                        <label for="cisd-equipment" class="block text-sm font-medium text-gray-700">Which piece(s) of
                            equipment do you want to be trained on?</label>
                        <select id="cisd-equipment" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            <option value="ftir">Fourier-transform infrared spectroscopy (FTIR)</option>
                            <option value="dsc">Differential Scanning Calorimetry (DSC) - NETZSCH</option>
                            <option value="utm-20-50n">Universal testing machine - Load cell 20 and 50N</option>
                            <option value="utm-2.5kn">Universal testing machine - Load cell 2.5KN</option>
                            <option value="capillary-rheology">Capillary rheology</option>
                            <option value="polarised-microscope">Polarised microscope</option>
                            <option value="respirometer">Respirometer</option>
                            <option value="colorimeter">Colorimeter</option>
                            <option value="contact-angle">Contact Angle - First Ten Angstroms</option>
                            <option value="hardness-shore">Hardness Shore</option>
                            <option value="density-balance">Density Balance</option>
                            <option value="compression-testing">Compression Testing</option>
                            <option value="flexure-testing">Flexure Testing</option>
                            <option value="impact-testing">Impact Testing</option>
                            <option value="ta-rheometer">TA Rheometer</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Submit Request</button>
                </form>
            </div>

            <!-- APT Form -->
            <div id="apt-form" class="form-section">
                <h3 class="text-xl font-bold mb-2">APT Booking Request Form TUS</h3>
                <p class="text-sm text-gray-600 mb-4">Submit by 3:45 PM the day before (Mon-Fri). Await APT staff
                    approval.</p>
                <form id="apt-form-fields">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Have you completed the safety
                            documentation related to the equipment and materials you plan on using?</label>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                <input type="radio" name="apt-safety" value="yes" class="form-radio" required>
                                <span class="ml-2">Yes</span>
                            </label>
                            <label class="inline-flex items-center ml-6">
                                <input type="radio" name="apt-safety" value="no" class="form-radio">
                                <span class="ml-2">No</span>
                            </label>
                        </div>
                        <p id="apt-safety-message" class="text-red-500 hidden">You'll need to complete safety
                            documentation to proceed.</p>
                    </div>
                    <div class="mb-4">
                        <label for="apt-project" class="block text-sm font-medium text-gray-700">Project associated with
                            this booking</label>
                        <select id="apt-project" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                            required>
                            <option value="algamy">Algamy</option>
                            <option value="apos">APOS</option>
                            <option value="buddie-pack">Buddie-Pack</option>
                            <option value="confirm">CONFIRM</option>
                            <option value="ecoplastic">Ecoplastic</option>
                            <option value="enervegen">ENerveGen</option>
                            <option value="marinochem">Marinochem</option>
                            <option value="magicbiomat">MAGICBIOMAT</option>
                            <option value="mti">MTI</option>
                            <option value="ostoform">Ostoform</option>
                            <option value="pepsico">PepsiCo</option>
                            <option value="perpetual">PerPETual</option>
                            <option value="supernode">Supernode</option>
                            <option value="ipp-feasibility">IPP Feasibility</option>
                            <option value="innovation-voucher">Innovation Voucher</option>
                            <option value="phd-project">PhD Project</option>
                            <option value="apt-direct-funding">APT Direct Direct Funding</option>
                            <option value="cisd">CISD</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="apt-purpose" class="block text-sm font-medium text-gray-700">Purpose of Booking
                            (Select all that apply)</label>
                        <select id="apt-purpose" multiple
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="processing">Processing</option>
                            <option value="testing">Testing</option>
                            <option value="conditioning">Conditioning</option>
                            <option value="training">Training</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="apt-booking-date" class="block text-sm font-medium text-gray-700">Required Booking
                            Date (DD/MM/YY)</label>
                        <input type="text" id="apt-booking-date" pattern="\d{2}/\d{2}/\d{2}"
                            placeholder="DD/MM/YY (e.g., 17/07/25)"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="apt-equipment" class="block text-sm font-medium text-gray-700">Which piece of
                            equipment do you want to book?</label>
                        <select id="apt-equipment" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                            required>
                            <option value="">Select an equipment</option>
                            <option value="air-cooled-conveyor">Air Cooled Conveyor</option>
                            <option value="arburg-allrounder">Arburg Allrounder Moulding Machine</option>
                            <option value="arburg-freeformer">Arburg Freeformer</option>
                            <option value="babyplast">Babyplast</option>
                            <option value="ball-mill">Ball Mill</option>
                            <option value="brabender-extuder">Brabender Extuder</option>
                            <option value="conveyor-belt">Conveyor belt</option>
                            <option value="compression-moulder">Compression Moulder</option>
                            <option value="ct-scanner">CT Scanner</option>
                            <option value="demag-sumitomo-im">Demag Sumitomo IM</option>
                            <option value="filament-line">Filament Line</option>
                            <option value="filament-maker">Filament Maker (Table Top)</option>
                            <option value="flir-camera">FLIR camera</option>
                            <option value="furnace-carbolite">Furnace Carbolite</option>
                            <option value="formech-vac-former">Formech Vac Former</option>
                            <option value="granulator-rapid">Granulator Rapid</option>
                            <option value="granulator-prism">Granulator Prism</option>
                            <option value="high-temp-compounder">High Temp Compounder</option>
                            <option value="humidity-chamber-1">Humidity Chamber 1</option>
                            <option value="humidity-chamber-2">Humidity Chamber 2</option>
                            <option value="large-prism-twin-screw">Large Prism Twin Screw Extruder (16 mm)</option>
                            <option value="leistritz-twin-screw">Leistritz Twin Screw Extruder</option>
                            <option value="lsr-fanuc">LSR Fanuc</option>
                            <option value="melt-spinning-line">Melt Spinning Line</option>
                            <option valued="microtome">Microtome</option>
                            <option value="mfi-tester">MFI Tester</option>
                            <option value="miller-retsch">Miller Retsch</option>
                            <option value="multilayer-cast-extrusion">Multilayer Cast Extrusion Line</option>
                            <option value="rex-extruder">REX Extruder</option>
                            <option value="sieve-shaker">Sieve Shaker</option>
                            <option value="small-prism-twin-screw">Small Prism Twin Screw Extruder</option>
                            <option value="tech-dryer">Tech Dryer</option>
                            <option value="3d-printer-intamsys">3D Printer Intamsys FunMAT HT PEEK</option>
                            <option value="3d-printer-makergear">3D Printer Makergear</option>
                            <option value="3d-printer-sigmax">3D Printer Sigmax BCN3D</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="apt-mould" class="block text-sm font-medium text-gray-700">Specify mould, equipment,
                            screw, die, etc. (n/a if not applicable)</label>
                        <input type="text" id="apt-mould"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Do you need to book the use of one of the
                            ovens?</label>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                <input type="radio" name="apt-oven" value="yes" class="form-radio" required>
                                <span class="ml-2">Yes</span>
                            </label>
                            <label class="inline-flex items-center ml-6">
                                <input type="radio" name="apt-oven" value="no" class="form-radio">
                                <span class="ml-2">No</span>
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Submit Booking
                        Request</button>
                </form>
                <div id="booking-process" class="hidden mt-8">
                    <h3 id="current-equipment-title" class="text-xl font-bold mb-4"></h3>
                    <div id="calendar"></div>
                    <button id="book-btn" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Book this
                        Equipment</button>
                    <p id="booking-status" class="mt-2 text-red-500"></p>
                </div>
            </div>
        </div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js'></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const tabLinks = document.querySelectorAll(".tab-link");
            const tabContents = document.querySelectorAll(".tab-content");
            const formSelect = document.getElementById('form-select');
            const cisdForm = document.getElementById('cisd-form');
            const aptForm = document.getElementById('apt-form');
            const calendarEl = document.getElementById('calendar');
            let calendar;
            let selectedEquipment = [];
            let currentEquipmentIndex = 0;
            let bookingDate = '';
            let currentSelection = null;
            let bookingData = {};

            // Tab Navigation
            tabLinks.forEach(link => {
                link.addEventListener("click", function (e) {
                    e.preventDefault();
                    const tabId = this.getAttribute("href").substring(1);
                    tabContents.forEach(content => content.classList.remove("active"));
                    document.getElementById(tabId).classList.add("active");
                });
            });
            tabLinks[0].click();

            // Identity Verification
            document.getElementById('user-auth-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const userName = document.getElementById('user-name').value;
                const userEmail = document.getElementById('user-email').value;
                let identity = 'Unknown';

                if (userEmail.endsWith('@admin.tus.ie')) {
                    identity = 'Admin';
                } else if (userEmail.endsWith('@student.tus.ie')) {
                    identity = 'Student';
                } else if (userEmail.endsWith('@random')) {
                    identity = 'Guest';
                }

                document.getElementById('identity-status').textContent = `Welcome, ${userName}! You are identified as a ${identity}.`;
                if (identity === 'Admin') {
                    alert('Admin detected. Administrator interface is not yet implemented. Please contact support.');
                    document.getElementById('user-auth-form').style.display = 'none';
                    return;
                }
                document.getElementById('user-auth-form').style.display = 'none';
                document.getElementById('form-selection').style.display = 'block';

                window.userIdentity = { name: userName, email: userEmail, role: identity };
            });

            // Form Selection
            formSelect.addEventListener('change', function() {
                cisdForm.classList.remove('active');
                aptForm.classList.remove('active');
                if (this.value === 'cisd') {
                    cisdForm.classList.add('active');
                } else if (this.value === 'apt') {
                    aptForm.classList.add('active');
                }
            });

            // CISD Form Logic
            const cisdPurpose = document.getElementById('cisd-purpose');
            const cisdEquipmentTraining = document.getElementById('cisd-equipment-training');
            const cisdSafetyRadios = document.querySelectorAll('input[name="cisd-safety"]');
            const cisdSafetyMessage = document.getElementById('cisd-safety-message');
            const cisdSubmitBtn = document.querySelector('#cisd-form-fields button[type="submit"]');

            cisdSafetyRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'no') {
                        cisdSafetyMessage.classList.remove('hidden');
                        cisdSubmitBtn.disabled = true;
                    } else {
                        cisdSafetyMessage.classList.add('hidden');
                        cisdSubmitBtn.disabled = false;
                    }
                });
            });

            cisdPurpose.addEventListener('change', function () {
                cisdEquipmentTraining.classList.toggle('hidden', this.value !== 'training');
            });

            document.getElementById('cisd-form-fields').addEventListener('submit', function(e) {
                e.preventDefault();
                const safety = document.querySelector('input[name="cisd-safety"]:checked');
                if (!safety || safety.value === 'no') {
                    document.getElementById('cisd-safety-message').classList.remove('hidden');
                    return;
                }
                alert(`CISD Request Submitted by ${window.userIdentity.name} (${window.userIdentity.email}). Please wait for approval from CISD staff.`);
            });

            // APT Form Logic
            const aptSafetyRadios = document.querySelectorAll('input[name="apt-safety"]');
            const aptSafetyMessage = document.getElementById('apt-safety-message');
            const aptSubmitBtn = document.querySelector('#apt-form-fields button[type="submit"]');

            aptSafetyRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'no') {
                        aptSafetyMessage.classList.remove('hidden');
                        aptSubmitBtn.disabled = true;
                    } else {
                        aptSafetyMessage.classList.add('hidden');
                        aptSubmitBtn.disabled = false;
                    }
                });
            });

            // APT Form Submission
            document.getElementById('apt-form-fields').addEventListener('submit', function(e) {
                e.preventDefault();
                const safety = document.querySelector('input[name="apt-safety"]:checked');
                if (!safety || safety.value === 'no') {
                    alert('You must complete the safety documentation to proceed.');
                    return;
                }
                const equipmentSelect = document.getElementById('apt-equipment');
                const equipment = equipmentSelect.value;
                const dateInput = document.getElementById('apt-booking-date');
                const date = dateInput.value;
                if (!equipment || !/^\d{2}\/\d{2}\/\d{2}$/.test(date)) {
                    alert('Please select an equipment and enter a valid date (DD/MM/YY).');
                    return;
                }
                bookingData = { equipment, date };
                showNextEquipment();
            });

            function showNextEquipment() {
                if (currentEquipmentIndex >= 1) {
                    const continueBooking = confirm('Booking completed. Would you like to book another machine?');
                    if (continueBooking) {
                        document.getElementById('booking-process').classList.add('hidden');
                        document.getElementById('apt-form-fields').reset();
                        return;
                    } else {
                        alert('All bookings completed. Thank you!');
                        document.getElementById('booking-process').classList.add('hidden');
                        document.getElementById('apt-form-fields').reset();
                        return;
                    }
                }
                const equipmentText = document.querySelector(`#apt-equipment option[value="${bookingData.equipment}"]`).text;
                document.getElementById('current-equipment-title').textContent = `Booking for ${equipmentText} on ${bookingData.date}`;
                initCalendar();
                document.getElementById('booking-process').classList.remove('hidden');
            }

            function initCalendar() {
                if (calendar) calendar.destroy();
                const parsedDate = parseDate(bookingData.date);
                if (!parsedDate) {
                    document.getElementById('booking-status').textContent = 'Invalid date format. Please use DD/MM/YY (e.g., 17/07/25).';
                    return;
                }
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridDay',
                    initialDate: parsedDate,
                    slotMinTime: '08:00:00',
                    slotMaxTime: '18:00:00',
                    slotDuration: '00:30:00',
                    allDaySlot: false,
                    selectable: true,
                    select: function(info) {
                        // 检查所选时间段是否与现有预约冲突
                        const bookings = calendar.getEvents();
                        const selectedStart = info.start;
                        const selectedEnd = info.end;
                        const isConflict = bookings.some(event => {
                            return selectedStart < event.end && selectedEnd > event.start;
                        });
                        if (isConflict) {
                            document.getElementById('booking-status').textContent = 'This time slot is already booked.';
                            currentSelection = null;
                        } else {
                            currentSelection = info;
                            document.getElementById('booking-status').textContent = '';
                            console.log('Selected time:', info.start, info.end);
                        }
                    },
                    events: function(fetchInfo, successCallback, failureCallback) {
                        // 从后端获取预约数据
                        fetch(`/api/bookings/availability?equipment=${encodeURIComponent(bookingData.equipment)}&date=${bookingData.date}`)
                            .then(response => {
                                if (!response.ok) throw new Error('Failed to fetch bookings');
                                return response.json();
                            })
                            .then(data => {
                                const events = data.map(booking => {
                                    const [startTime, endTime] = booking.timeSlot.split('-');
                                    return {
                                        title: `${booking.equipment} (Booked)`,
                                        start: `${parsedDate}T${startTime}:00`,
                                        end: `${parsedDate}T${endTime}:00`,
                                        backgroundColor: 'red', // 已预约显示为红色
                                        borderColor: 'red',
                                        editable: false // 禁止拖动
                                    };
                                });
                                successCallback(events);
                            })
                            .catch(error => {
                                console.error('Error fetching bookings:', error);
                                failureCallback(error);
                            });
                    },
                    height: 'auto'
                });
                calendar.render();
                calendar.gotoDate(parsedDate);
                console.log('Calendar initialized for date:', parsedDate);
            }

            function parseDate(dateStr) {
                if (!dateStr || !/^\d{2}\/\d{2}\/\d{2}$/.test(dateStr)) return null;
                const [day, month, year] = dateStr.split('/');
                return `20${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }

            // Confirm Booking
            document.getElementById('book-btn').addEventListener('click', function() {
                if (!currentSelection) {
                    document.getElementById('booking-status').textContent = 'Please select a time slot.';
                    return;
                }
                const startTime = currentSelection.start.toISOString().substring(11, 16); // HH:mm
                const endTime = currentSelection.end.toISOString().substring(11, 16); // HH:mm
                const timeSlot = `${startTime}-${endTime}`;
                const duration = (currentSelection.end - currentSelection.start) / (1000 * 60 * 60); // 单位：小时
                const status = duration > 2 ? 'Pending' : 'Confirmed';

                const booking = {
                    name: window.userIdentity.name,
                    email: window.userIdentity.email,
                    equipment: bookingData.equipment,
                    date: bookingData.date,
                    timeSlot: timeSlot,
                    status: status
                };

                fetch('/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(booking)
                })
                    .then(response => {
                        if (response.status === 409) { // CONFLICT
                            throw new Error('This time slot is already booked.');
                        }
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        alert(`Booking submitted successfully. Status: ${data.status}`);
                        calendar.addEvent({
                            title: `${booking.equipment} (Booked)`,
                            start: `${parseDate(booking.date)}T${startTime}:00`,
                            end: `${parseDate(booking.date)}T${endTime}:00`,
                            backgroundColor: 'red',
                            borderColor: 'red',
                            editable: false
                        });
                        currentSelection = null;
                        currentEquipmentIndex++;
                        showNextEquipment();
                    })
                    .catch(error => {
                        document.getElementById('booking-status').textContent = error.message;
                        console.error('Error submitting booking:', error);
                    });
            });
        });
    </script>
</body>

</html>